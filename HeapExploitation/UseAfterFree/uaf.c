#include <stdio.h>
#include <string.h>
#include <stdlib.h>


int main(int argc, char **argv){
	system("clear");
	puts("\t\t\t\t\t[ Use After Free ]");
	puts("\t\t\t\t\t------------------");

	fprintf(stderr, "- This will be used to illustrate UAF Vulnerability to leak the address of libc\n");
	fprintf(stderr, "- The file can be compiled in the lastest version of libc\n\n");
	
	unsigned long *a, *b, *c, *d; 
	
	a = (unsigned long *) malloc(0x500); // This is a large bin allocated. This will end up in the unsorted bin and not the tcache since size > 0x500
	c = (unsigned long *) malloc(0x10); // This is used to prevent coalasing of the 2 freed() large chunks.
	d = (unsigned long *) malloc(0x500); // This is a large chunk freed() and pointer set to NULL to show the differe
	b = (unsigned long *) malloc(0x10); // This is used to prevent consolidation with the TopChunk after free
	fprintf(stderr, "- We allocate three chunks: \n\tChunk(a): %p [This is the large bin chunk to free()]\n\tChunk(b): %p [This chunk is used to prevent consolidation with the TopChunk after chunk (d) is freed]\n\tChunk(c): %p [ This is used to prevent the coalasing of the 2 freed() large bin chunks]\n", a, b, c);
	fprintf(stderr, "\tChunk(d): %p [This chunk will be freed() and the pointer NULLed out. Therefore we will see how UAF can be defeated]\n", d);
	
	fprintf(stderr, "\n- We therefore free chunk(a) and chunk(d)\n");
	free(a);free(d);
	fprintf(stderr, "- We NULL out the pointer that chunk(d) was pointing to in the Heap. This can be used to prevent UAFs\n");
	d = NULL;

	fprintf(stderr, "- The unsigned long pointer (a) still points to the heap. The unsorted bin to be specific. Therefore pointing at the (fd) pointer of the UnsortedBin\n");
	fprintf(stderr, "- Thus we use this to our advantage to leak the libc address:\n");
	
	fprintf(stderr, "\t\t- The (fd) pointer of the UnsortedBin [%p]\n", *a);
	fprintf(stderr, "- Leaking the address with the pointer pointed to by [d] is [%p]\n", d);
	return 0;
}
